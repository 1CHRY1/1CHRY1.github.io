### 来自拼多多提前批一面面经

#### G1垃圾回收器如何预测停顿时间？Region大小如何设置？

G1是Java堆并行收集器，是JDK1.7提供的一个新 收集器，基于“标记-整理”算法实现，回收的范围是包括新生代老生代的整个Java堆。

G1的预测机制主要依赖“回收成本模型”+“用户期望”来实现。G1在并发标记阶段会统计 *每个Region的回收成本*，包括**Region的存活率**，**Region回收耗时的历史值**以及**对象分布和引用集的大小**（扫描耗时）

G1会把每个Region回收成本按历史数据建模，进行GC时会从回收价值最高的Region开始依次累加Region的预测耗时，累加预测耗时值接近MaxGCPauseMillis时停止选择更多Region，这样G1就能挑一批回收最快收益最大的Region进行回收并优先满足停顿目标。

G1会将Java堆划分为固定大小的Region，它们逻辑连续但物理不连续，默认是`堆大小/2048 在向上取整到2的幂次方`，范围是1MB-32MB。若堆较大则可以手动调大RegionSize的大小而减少Region数量，若需要精细的停顿控制，可调小RegionSize提高回收粒度，但要注意元数据的开销。

在其中若Region太小则会发生Region数量多，RSet（每个 Region 都有自己的 RSet，它存储来自其他 Region 指向本 Region 的引用位置）维护开销大，GC追踪引用的元数据膨胀。若Region太大则细粒度下降，不容易精准控制停顿时间。