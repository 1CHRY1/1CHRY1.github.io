### 记不得哪看的了

#### 什么是内存屏障？

内存屏障（Memory Barrier），又称内存栅栏，是一种 CPU 指令，用于限制编译器和 CPU 对指令的重排序，确保在多线程环境下内存操作的可见性和有序性。

在多线程程序中，编译器会对代码指令进行重排序，CPU也可能会乱序执行指令，多线程之间的共享变量更新也并不总是对其他线程可见，**这可能会导致线程读取到旧值或者中间状态而导致线程安全问题**，需要内存屏障来避免这种不可预知的行为。

内存屏障的作用主要是：1防止重排序，2保证可见性；

常用的内存屏障有
LoadLoad Barrier：屏障之后的所有读操作不能被重排到屏障之前的读操作之前。
StoreStore Barrier：屏障之前的所有写操作不能被重排到屏障之后的写操作之后。
LoadStore Barrier：屏障之后的写操作不能被重排到屏障之前的读操作之前。
StoreLoad Barrier：最强的屏障，屏障之前的写不能被重排到屏障之后的读操作之后（保障可见性）

Java中没有显示的内存屏障指令，只有隐式的插入，如：
- volatile关键字中，对volatile变量的写操作前会插入StoreStore Barrier，读操作后会插入LoadLoad Barrier和LoadStore Barrier
保证变量的写入对其他线程可见，并且禁止重排序
- synchronized和Lock
synchronized进入时会插入LoadLoad和LoadStore，退出时会插入StoreStore和StoreLock，显示锁入ReentrantLock和unlock也有类似机制
保证获取锁后其他线程写入的变量可以被当前线程看到，释放锁前所有的写操作对其他线程可见且写操作不能排在锁释放之后。
- Unsafe类和varHandler
同理