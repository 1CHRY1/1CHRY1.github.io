### 来自小林coding

#### 如何设计一个秒杀场景

首先秒杀场景需要解决几个核心问题：
- 高并发处理，应对大量用户同时访问
- 库存一致性，保证库存不会超卖或少卖
- 用户体验性，减少用户等待时间，避免页面崩溃
- 防刷机制，防止恶意用户利用脚本抢购商品

前端层设计：
- 静态资源分离：将秒杀页面的静态资源部署到CDN（内存分发网络）中，减轻服务器的压力。
- 请求拦截：活动未开始时前端变灰，通过验证码和点击的频率限制请求。

网关层设计：
- 流量拦截：使用API网关对请求进行初步过滤，如IP限流和黑名单拦截
- 身份验证：使用Token或签名验证用户身份，防止未登录用户访问秒杀接口

缓存层设计：
- Redis缓存库存：将商品库存信息存在Redis中，处理库存扣减操作
- 预热数据：在秒杀活动开始前就将数据加载到Redis中，减少数据库压力

消息队列：
- 削峰填谷：使用消息队列将用户秒杀的请求异步化，防止直接冲击后端服务
- 订单处理：将成功的秒杀请求放入队列，后台服务异步生成订单，提高系统吞吐量

数据库层：
- 乐观锁：库存扣减时使用乐观锁确保库存一致性
- 读写分离：通过主从复制实现数据库读写分离，提高查询性能

秒杀流程：
- 请求到达：系统接收后进行基础校验如用户身份活动情况等。若通过则进入库存扣减的环节。
- 库存扣减：在Redis中查看库存是否充足，先使用GET命令查看库存，若库存不足则返回失败，若库存充足则使用Redis原子操作扣减库存
- 更新数据库：若扣减成功则生成一条秒杀成功消息并放入消息队列
- 后台服务消费消息：首先为用户创建订单，使用乐观锁将数据库中的库存数量减少1，还要通过唯一标识防止消息的重复消费
- 最终一致性校验：要保证Redis扣减和数据库库存更新后最终的一致性，需要定期将Redis中库存数据与数据库进行同步，若发现不一致，需要触发补偿逻辑，如补偿回滚订单或调整库存