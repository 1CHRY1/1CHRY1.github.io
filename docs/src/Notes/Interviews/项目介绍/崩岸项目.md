## 长江崩岸预警项目亮点

### 基于SpringAOP的动态数据源切换

#### 数据源切换方式

1. DataSourceRouting 继承 AbstractRoutingDataSource
- 重写 determineCurrentLookupKey()，每次 getConnection() 前都会调用它，决定当前线程用哪个数据源。
- 从 DataSourceContextHolder（ThreadLocal）中取 key。
2. AOP 切面拦截业务方法
- 在 @Around 通知中，从参数拿到 DataNodeV2，根据它的属性生成一个唯一 key。
- 如果数据源不存在，就用 DataSourceBuilder 动态创建一个新的 DataSource，加入 DataSourceRouting 的内部 Map。
- 调用 DataSourceContextHolder.setDataSourceKey(key) 把当前线程的数据源 key 存入 ThreadLocal。
- 执行业务逻辑，MyBatis 调用数据源时会走到 determineCurrentLookupKey()，取到刚设置的 key，从而切到对应数据源。
- 方法执行完毕后，把 key 恢复为 "default"。

调用流程为：
1) 调用 Service 方法
2) AOP 前置：ThreadLocal 设 key = "xxxx"
3) 业务逻辑 -> MyBatis Mapper 方法 -> JDBC需要连接
4) MyBatis 调用 dynamicDataSource.getConnection()
5) dynamicDataSource 调用 determineCurrentLookupKey()
6) determineCurrentLookupKey 从 ThreadLocal 取 key
7) 用这个 key 从内部 Map 找到对应 DataSource
8) DataSource.getConnection() → 执行 SQL
9) AOP 后置：ThreadLocal 设回 "default"

#### 亮点

构建一个切面用于切换数据源，使用Aroud注解实现当前切点前后逻辑的实现。

基于AbstractRoutingDataSource实现了一个数据源的抽象路由，在内部维护了一个数据源列表并提供相关的数据源操作，MyBatis在执行SQL时能够执行数据源切换。

在数据查询开始前获取基于数据节点的数据源标识并存入ThreadLocal，查询后再切换为默认数据源。

这种方式不仅支持多数据源的运行时动态添加，还保证了线程隔离和事务管理的兼容性，极大提升了系统对多租户、多数据库场景的适配能力。